<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shooter 3D - COD Mobile</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
        }

        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        /* Bot√≥n pantalla completa */
        #fullscreenBtn {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 3px solid #00ff00;
            border-radius: 10px;
            cursor: pointer;
            pointer-events: auto;
            font-weight: bold;
            font-size: 16px;
            z-index: 1002;
            text-transform: uppercase;
        }

        #fullscreenBtn:active {
            background: rgba(0, 255, 0, 0.5);
            transform: scale(0.95);
        }

        /* Controles de movimiento izquierda */
        #moveControls {
            position: absolute;
            left: 30px;
            bottom: 40px;
            width: 200px;
            height: 200px;
            pointer-events: auto;
            z-index: 1001;
        }

        .move-btn {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.4);
            border: 4px solid rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            touch-action: none;
        }

        .move-btn:active {
            background: rgba(255, 255, 255, 0.8);
            transform: scale(0.9);
        }

        #btnUp {
            top: 0;
            left: 70px;
        }

        #btnDown {
            bottom: 0;
            left: 70px;
        }

        #btnLeft {
            top: 70px;
            left: 0;
        }

        #btnRight {
            top: 70px;
            right: 0;
        }

        /* Controles de acci√≥n derecha */
        #actionControls {
            position: absolute;
            right: 30px;
            bottom: 40px;
            width: 220px;
            height: 150px;
            pointer-events: auto;
            z-index: 1001;
        }

        #jumpBtn {
            position: absolute;
            left: 0;
            bottom: 10px;
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 0, 0.5);
            border: 5px solid rgba(0, 255, 0, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
            touch-action: none;
            text-align: center;
        }

        #jumpBtn:active {
            background: rgba(0, 255, 0, 0.8);
            transform: scale(0.9);
        }

        #shootBtn {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 0, 0, 0.5);
            border: 5px solid rgba(255, 0, 0, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            touch-action: none;
            text-align: center;
        }

        #shootBtn:active {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(0.9);
        }

        /* √Årea de mirar (giroscopio t√°ctil) */
        #lookArea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            z-index: 999;
        }

        /* Crosshair */
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 1003;
        }

        .crosshair-line {
            position: absolute;
            background: white;
            box-shadow: 0 0 3px black;
        }

        .crosshair-h {
            width: 20px;
            height: 3px;
            top: 18px;
            left: 10px;
        }

        .crosshair-v {
            width: 3px;
            height: 20px;
            top: 10px;
            left: 18px;
        }

        /* Info superior */
        #info {
            position: absolute;
            top: 15px;
            left: 15px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 2px 2px 4px black;
            pointer-events: none;
            z-index: 1002;
        }
    </style>
</head>
<body>
    <a-scene 
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">
        
        <!-- Cielo celeste -->
        <a-sky color="#87CEEB"></a-sky>

        <!-- Piso verde 20x20 -->
        <a-plane 
            position="0 0 0" 
            rotation="-90 0 0" 
            width="20" 
            height="20" 
            color="#228B22"
            shadow="receive: true">
        </a-plane>

        <!-- Cubo rojo enemigo -->
        <a-box 
            id="enemy" 
            position="5 1 5" 
            width="1" 
            height="1" 
            depth="1" 
            color="#FF0000"
            shadow="cast: true">
        </a-box>

        <!-- Jugador con c√°mara -->
        <a-entity id="rig" position="0 0 0">
            <a-camera 
                id="camera" 
                position="0 1.6 0"
                look-controls="enabled: false"
                wasd-controls="enabled: false">
            </a-camera>
        </a-entity>

        <!-- Iluminaci√≥n -->
        <a-light type="ambient" intensity="0.6"></a-light>
        <a-light type="directional" position="5 10 2" intensity="0.7" cast-shadow="true"></a-light>
    </a-scene>

    <!-- UI Overlay -->
    <div id="ui-overlay">
        <!-- Bot√≥n pantalla completa -->
        <button id="fullscreenBtn">üñ•Ô∏è PANTALLA COMPLETA</button>

        <!-- Info -->
        <div id="info">Shooter 3D</div>

        <!-- Crosshair -->
        <div id="crosshair">
            <div class="crosshair-line crosshair-h"></div>
            <div class="crosshair-line crosshair-v"></div>
        </div>

        <!-- √Årea de mirar (t√°ctil) -->
        <div id="lookArea"></div>

        <!-- Controles de movimiento -->
        <div id="moveControls">
            <div class="move-btn" id="btnUp">‚ñ≤</div>
            <div class="move-btn" id="btnDown">‚ñº</div>
            <div class="move-btn" id="btnLeft">‚óÄ</div>
            <div class="move-btn" id="btnRight">‚ñ∂</div>
        </div>

        <!-- Controles de acci√≥n -->
        <div id="actionControls">
            <div id="jumpBtn">SALTAR</div>
            <div id="shootBtn">DISPARAR</div>
        </div>
    </div>

    <script>
        // Elementos del DOM
        const rig = document.querySelector('#rig');
        const camera = document.querySelector('#camera');
        const lookArea = document.querySelector('#lookArea');
        const scene = document.querySelector('a-scene');

        // Variables de estado
        let position = { x: 0, y: 1.6, z: 0 };
        let rotation = { x: 0, y: 0 };
        let velocity = { x: 0, y: 0, z: 0 };
        let isJumping = false;
        
        const moveSpeed = 0.15;
        const jumpSpeed = 0.4;
        const gravity = -0.02;
        const sensitivity = 0.3;

        // Estado de movimiento
        const movement = {
            forward: false,
            backward: false,
            left: false,
            right: false
        };

        // ========== PANTALLA COMPLETA ==========
        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            const elem = document.documentElement;
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => console.log('Error:', err));
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        });
        
        // Touch para celular
        document.getElementById('fullscreenBtn').addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const elem = document.documentElement;
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => console.log('Error:', err));
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                }
            }
        });

        // ========== CONTROLES DE MOVIMIENTO ==========
        function setupMovementButton(id, direction) {
            const btn = document.getElementById(id);
            
            const start = () => movement[direction] = true;
            const stop = () => movement[direction] = false;
            
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                start();
            });
            
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                stop();
            });
            
            btn.addEventListener('mousedown', start);
            btn.addEventListener('mouseup', stop);
            btn.addEventListener('mouseleave', stop);
        }

        setupMovementButton('btnUp', 'forward');
        setupMovementButton('btnDown', 'backward');
        setupMovementButton('btnLeft', 'left');
        setupMovementButton('btnRight', 'right');

        // ========== SALTAR ==========
        const jumpBtn = document.getElementById('jumpBtn');

        function jump() {
            if (position.y <= 1.6 && !isJumping) {
                velocity.y = jumpSpeed;
                isJumping = true;
            }
        }

        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            jump();
        });

        jumpBtn.addEventListener('click', (e) => {
            e.preventDefault();
            jump();
        });

        // ========== DISPARAR ==========
        const shootBtn = document.getElementById('shootBtn');

        function shoot() {
            // Obtener la rotaci√≥n REAL de la c√°mara (no la que guardo yo)
            const cameraRotation = camera.object3D.rotation;
            
            // Crear bala
            const bullet = document.createElement('a-sphere');
            bullet.setAttribute('radius', '0.15');
            bullet.setAttribute('color', '#FFFF00');
            bullet.setAttribute('shadow', 'cast: true');
            
            // Posici√≥n inicial: desde la c√°mara
            const cameraWorldPos = new THREE.Vector3();
            camera.object3D.getWorldPosition(cameraWorldPos);
            
            bullet.setAttribute('position', {
                x: cameraWorldPos.x,
                y: cameraWorldPos.y,
                z: cameraWorldPos.z
            });
            scene.appendChild(bullet);

            // Obtener el vector de direcci√≥n hacia donde mira la c√°mara
            const direction = new THREE.Vector3(0, 0, -1);
            direction.applyQuaternion(camera.object3D.quaternion);
            direction.normalize();

            // Animar bala
            let traveled = 0;
            const bulletSpeed = 0.8;
            const maxDistance = 50;

            const interval = setInterval(() => {
                const pos = bullet.getAttribute('position');
                
                // Mover la bala en la direcci√≥n 3D completa
                pos.x += direction.x * bulletSpeed;
                pos.y += direction.y * bulletSpeed;
                pos.z += direction.z * bulletSpeed;
                
                bullet.setAttribute('position', pos);
                traveled += bulletSpeed;

                // Verificar colisi√≥n con el cubo enemigo
                const enemy = document.getElementById('enemy');
                if (enemy) {
                    const enemyPos = enemy.getAttribute('position');
                    
                    const distance = Math.sqrt(
                        Math.pow(pos.x - enemyPos.x, 2) +
                        Math.pow(pos.y - enemyPos.y, 2) +
                        Math.pow(pos.z - enemyPos.z, 2)
                    );
                    
                    if (distance < 0.6) {
                        // ¬°Impacto! Cambiar color del cubo temporalmente
                        enemy.setAttribute('color', '#00FF00');
                        setTimeout(() => {
                            enemy.setAttribute('color', '#FF0000');
                        }, 200);
                        clearInterval(interval);
                        if (bullet.parentNode) {
                            scene.removeChild(bullet);
                        }
                        return;
                    }
                }

                // Eliminar si sale del rango o toca el suelo
                if (traveled >= maxDistance || pos.y < -1) {
                    clearInterval(interval);
                    if (bullet.parentNode) {
                        scene.removeChild(bullet);
                    }
                }
            }, 16);
        }

        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            shoot();
        });

        shootBtn.addEventListener('click', (e) => {
            e.preventDefault();
            shoot();
        });

        // ========== MIRAR ALREDEDOR (T√ÅCTIL Y MOUSE) ==========
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;

        lookArea.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastX = e.clientX;
            lastY = e.clientY;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - lastX;
                const deltaY = e.clientY - lastY;
                
                rotation.y -= deltaX * sensitivity;
                rotation.x -= deltaY * sensitivity;
                
                rotation.x = Math.max(-85, Math.min(85, rotation.x));
                
                lastX = e.clientX;
                lastY = e.clientY;
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Touch para m√≥vil
        lookArea.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                isDragging = true;
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
            }
        }, { passive: true });

        lookArea.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                const deltaX = e.touches[0].clientX - lastX;
                const deltaY = e.touches[0].clientY - lastY;
                
                rotation.y -= deltaX * sensitivity;
                rotation.x -= deltaY * sensitivity;
                
                rotation.x = Math.max(-85, Math.min(85, rotation.x));
                
                lastX = e.touches[0].clientX;
                lastY = e.touches[0].clientY;
            }
        }, { passive: true });

        lookArea.addEventListener('touchend', () => {
            isDragging = false;
        });

        // ========== TECLADO PC ==========
        document.addEventListener('keydown', (e) => {
            switch(e.key.toLowerCase()) {
                case 'w': movement.forward = true; break;
                case 's': movement.backward = true; break;
                case 'a': movement.left = true; break;
                case 'd': movement.right = true; break;
                case ' ': e.preventDefault(); jump(); break;
                case 'e': shoot(); break;
            }
        });

        document.addEventListener('keyup', (e) => {
            switch(e.key.toLowerCase()) {
                case 'w': movement.forward = false; break;
                case 's': movement.backward = false; break;
                case 'a': movement.left = false; break;
                case 'd': movement.right = false; break;
            }
        });

        // ========== LOOP PRINCIPAL ==========
        function gameLoop() {
            // Movimiento basado en rotaci√≥n
            const rad = rotation.y * Math.PI / 180;
            
            if (movement.forward) {
                position.x -= Math.sin(rad) * moveSpeed;
                position.z -= Math.cos(rad) * moveSpeed;
            }
            if (movement.backward) {
                position.x += Math.sin(rad) * moveSpeed;
                position.z += Math.cos(rad) * moveSpeed;
            }
            if (movement.left) {
                position.x -= Math.cos(rad) * moveSpeed;
                position.z += Math.sin(rad) * moveSpeed;
            }
            if (movement.right) {
                position.x += Math.cos(rad) * moveSpeed;
                position.z -= Math.sin(rad) * moveSpeed;
            }

            // F√≠sica de salto y gravedad
            velocity.y += gravity;
            position.y += velocity.y;

            if (position.y <= 1.6) {
                position.y = 1.6;
                velocity.y = 0;
                isJumping = false;
            }

            // L√≠mites del mapa
            position.x = Math.max(-9.5, Math.min(9.5, position.x));
            position.z = Math.max(-9.5, Math.min(9.5, position.z));

            // Actualizar posici√≥n y rotaci√≥n
            rig.setAttribute('position', position);
            camera.setAttribute('rotation', `${rotation.x} ${rotation.y} 0`);

            requestAnimationFrame(gameLoop);
        }

        // Iniciar cuando la escena cargue
        scene.addEventListener('loaded', () => {
            console.log('Juego iniciado');
            gameLoop();
        });
    </script>
</body>
</html>
